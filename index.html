<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>All in One Map Component</title>

  <link href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet">
  <link href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://github.com/downloads/lafeber/world-flags-sprite/flags32.css" />

  <style>
    html, 
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #wrapper {
      display: block;
      position:absolute;
      height:auto;
      bottom:0;
      top:0;
      left:0;
      right:0;
      padding: 10px;
    }

    #container {
      width: 100%;
      height: 100%;
    }

    .tooltip {
      position: absolute;
      left: 1px;
      bottom: 1px;
      min-width: 160px;
      max-width: 280px;
      height: 180px;
      padding: 10px;
      margin-left: 10px;
      margin-bottom: 10px;
      overflow-y: auto;
      background-color: rgba(255, 255, 255, 0.4);
      display: none;
    }

    .tooltip * {
      font-family: "Lucida Grande", "Lucida Sans Unicode", Arial, Helvetica, sans-serif;
    }

    .f32 .flag {
      vertical-align: middle !important;
    }
  </style>
</head>

<body>
<div id="wrapper">
  <div id="container"></div>
  <div class="tooltip"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.3.6/proj4.js"></script>
<script src="https://code.highcharts.com/maps/highmaps.js"></script>
<script src="https://code.highcharts.com/maps/modules/data.js"></script>
<script src="https://code.highcharts.com/mapdata/custom/world.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<!-- import sample json -->
<script src="json.js"></script>

<script>
  const groupBy = function (array, f) {
    var groups = {};
    array.forEach(function (o) {
      var group = JSON.stringify(f(o));
      groups[group] = groups[group] || [];
      groups[group].push(o);
    });
    return Object.keys(groups).map(function (group) {
      return groups[group];
    })
  }

  const trends = json.trends_by_region.map(function (el) {
    return {
      geoCode: el.geoCode,
      name: el.name,
      value: el.interest < 1 ? 1 : el.interest
    };
  });

  const history = groupBy(json.history, (el) => [el.location.lat, el.location.lon]).map((el) => {
    const single = el.length === 1;
    const name = single ? el[0].event.name : el.length + ' fights overlapped';
    const lat = el[0].location.lat;
    const lon = el[0].location.long;
    let marker = {};
    marker.symbol = 'diamond';
    if(single){
      if(el[0].winner){
        marker.fillColor = '#29a329';
      }else{
        marker.fillColor = '#ff4d4d';
      }
    }else{
      marker.symbol = 'square';
      marker.fillColor = '#000';
    }

    return {
      name: name,
      lat: lat,
      lon: lon,

      data: el,

      marker: marker
    };
  });

  const locations = [
    {
      type: 'Birth Location',
      name: json.birth_location.city,
      lat: json.birth_location.lat,
      lon: json.birth_location.long,
      marker: {
        symbol: 'url(location.png)'
      }
    },
    {
      type: 'Twitter Location',
      name: '',
      lat: json.twitter_location.lat,
      lon: json.twitter_location.long,
      marker: {
        symbol: 'url(twitter.png)'
      }
    },
    // {
    //   type: 'Gym Location',
    //   country: RU,
    //   name: Moscow,
    //   lat: 55.75222,
    //   lon: 37.61556,
    //   marker: {
    //     symbol: 'url(gym.png)'
    //   }
    // },
  ];

  const map = Highcharts.mapChart('container', {
    chart: {
      map: 'custom/world',
      borderWidth: 1,
      animation: false,
      events: {
        load: function(){
          const latLons = 
            history.map(
              el => ({lat: el.lat, lon: el.lon})
            ).concat(
              locations.map(
                el => ({lat: el.lat, lon: el.lon})
              )
            );

          const minLat = Math.min(...latLons.map(el => el.lat));
          const maxLat = Math.max(...latLons.map(el => el.lat));
          const centerLat = (minLat + maxLat) / 2;
          
          const minLon = Math.min(...latLons.map(el => el.lon));
          const maxLon = Math.max(...latLons.map(el => el.lon));
          const centerLon = (minLon + maxLon) / 2;
          
          const posCenter = this.fromLatLonToPoint({
            lat: centerLat, 
            lon: centerLon
          });
          const posMin = this.fromLatLonToPoint({
            lat: minLat, 
            lon: minLon
          });
          const posMax = this.fromLatLonToPoint({
            lat: maxLat, 
            lon: maxLon
          });

          const distanceX = Math.abs(posMax.x - posMin.x);
          const distanceY = Math.abs(posMax.y - posMin.y);

          const rangeX = Math.abs(this.xAxis[0].max - this.xAxis[0].min);
          const rangeY = Math.abs(this.yAxis[0].max - this.yAxis[0].min);
          const zoomLevelX = distanceX / rangeX;
          const zoomLevelY = distanceY / rangeY;
          const zoomLevel = Math.max(zoomLevelX, zoomLevelY) / 0.9;
          
          this.mapZoom(zoomLevel, posCenter.x, posCenter.y);
        },
        click: function (e) {
          console.log(e);
          $('.tooltip').hide();
        }
      }
    },

    legend: { enabled: false },

    title: {
      text: 'Fighter Information'
    },

    mapNavigation: {
      enabled: true,
      buttonOptions: {
        verticalAlign: 'top'
      }
    },

    tooltip: {
      enabled: false
    },

    colorAxis: {
      min: 0,
      stops: [
        [0, '#EFEFFF'],
        [0.5, Highcharts.getOptions().colors[0]],
        [1, Highcharts.color(Highcharts.getOptions().colors[0]).brighten(-0.5).get()]
      ]
    },

    plotOptions: {
      series: {
        stickyTracking: false,
        cursor: 'pointer',
        point: {
          events: {
            click: function (e) {
              let content;
              const tooltip = $('.tooltip');
              tooltip.empty();

              console.log('this',this);
              console.log('e',e);

              if (this.series.name === 'Location') {
                content = `
                  <div style="font-size: 12px;">${this.type}<div>
                  <div style="font-size:14px;">${this.name}</div>
                `;
              } else if (this.series.name === 'History') {
                content = `
                  <div style="font-size: 12px;">${this.series.name}</div>
                  ${
                    this.data.map((el) => `
                      <div style="font-size:13px; font-weight: bold;">- ${el.event.name}</div>
                      <div style="font-size: 12px;">(${el.event.promotion})</div>
                      <div style="font-size: 10px;">
                        ${moment(el.event.date).format('MMM DD, YYYY')} - dur: ${el.time}
                      </div>
                      <div style="font-size: 12px;">
                        Fighter: 
                          ${el.winner
                        ? el.winning_fighter_name
                        : el.losing_fighter_name
                      }
                      </div>         
                      <div style="font-size: 12px;">
                        Opponent: 
                          ${el.winner
                        ? el.losing_fighter_name
                        : el.winning_fighter_name
                      }
                      </div>
                      <div style="font-size: 12px;">
                        Game Result: ${el.winner ? 'Win' : 'Lose'}  
                      </div>
                      <div style="font-size: 12px;">
                        ${el.rounds}  
                      </div>
                      <div style="
                        display: block;
                        font-size: 12px;
                        text-indent: -57px;
                        padding-left: 57px;
                      ">
                        Location: ${el.location.city}  
                      </div>
                    `).join('')
                  }
                `;
              } else {
                content = `
                  <span class="f32">
                    <span class="flag ${this.properties['hc-key']}"></span>
                  </span> 
                  <span>${this.name}</span>
                  <div style="font-size:14px">Google trends: ${this.value}</div>
                `;
              }

              tooltip.append(content);
              tooltip.show();
            }
          }
        }
      }
    },

    series: [
      {
        mapData: Highcharts.maps['custom/world']
      },

      { // History
        type: 'mappoint',
        name: 'History',
        zIndex: 30,
        lineWidth: 1,
        color: 'rgba(0, 51, 204, 0.3)',

        marker: {
          radius: 6,
        },

        data: history,
      },

      { // Location
        type: 'mappoint',
        name: 'Location',
        zIndex: 40,

        marker: {
          fillColor: '#0F0'
        },

        data: locations
      },


      { // Trends
        data: trends,
        joinBy: ['iso-a2', 'geoCode'],
        name: 'Google trends',
        states: {
          hover: {
            color: '#a4edba'
          }
        }
      },
    ],
  });
</script>
</body>

</html>